@model Trackii.Models.Admin.Route.RouteEditVm

<h2>Editar Ruta: @Model.Version</h2>

<form method="post" action="/Admin/Route/Save">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="Version" />

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">@Html.ValidationSummary()</div>
    }

    <div class="row">
        <div class="col-md-6">
            <label>Subfamilia</label>
            <select asp-for="SubfamilyId" class="form-select" required>
                @foreach (var s in ViewBag.Subfamilies as List<(uint Id, string Name)>)
                {
                    if (s.Id == Model.SubfamilyId)
                    {
                        <option value="@s.Id" selected>@s.Name</option>
                    }
                    else
                    {
                        <option value="@s.Id">@s.Name</option>
                    }
                }
            </select>
            <small class="text-muted">Nota: Si cambias la subfamilia, la ruta pasará a ser inactiva para evitar conflictos.</small>
        </div>
        <div class="col-md-6">
            <label>Nombre de Ruta</label>
            <input asp-for="Name" class="form-control" required />
        </div>
    </div>

    <hr />
    <h4>Pasos del Proceso</h4>

    <table class="table table-bordered" id="stepsTable">
        <thead>
            <tr>
                <th width="50">#</th>
                <th>Ubicación (Location)</th>
                <th width="120">Acción</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Steps.Count; i++)
            {
                <tr>
                    <td class="step-index">@(i + 1)</td>
                    <td>
                        <select name="Steps[@i].LocationId" class="form-select">
                            @foreach (var l in ViewBag.Locations as List<(uint Id, string Name)>)
                            {
                                if (l.Id == Model.Steps[i].LocationId)
                                {
                                    <option value="@l.Id" selected>@l.Name</option>
                                }
                                else
                                {
                                    <option value="@l.Id">@l.Name</option>
                                }
                            }
                        </select>
                        <input type="hidden" name="Steps[@i].StepNumber" value="@(i + 1)" />
                    </td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveStepUp(this)" title="Subir">↑</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveStepDown(this)" title="Bajar">↓</button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeStep(this)" title="Eliminar">X</button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" class="btn btn-secondary" onclick="addStep()">+ Agregar Paso</button>
    <br /><br />

    <button type="submit" class="btn btn-primary btn-lg">Guardar Cambios</button>
    <a href="/Admin/Route" class="btn btn-light">Cancelar</a>
</form>

<div style="display:none;">
    <select id="locationsSource">
        @foreach (var l in ViewBag.Locations as List<(uint Id, string Name)>)
        {
            <option value="@l.Id">@l.Name</option>
        }
    </select>
</div>

@section Scripts {
    <script>
        function addStep() {
            var tbody = document.querySelector("#stepsTable tbody");
            var index = tbody.rows.length;
            var options = document.getElementById("locationsSource").innerHTML;

            var row = `
                <tr>
                    <td class="step-index">${index + 1}</td>
                    <td>
                        <select name="Steps[${index}].LocationId" class="form-select">
                            ${options}
                        </select>
                        <input type="hidden" name="Steps[${index}].StepNumber" value="${index + 1}" />
                    </td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveStepUp(this)">↑</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveStepDown(this)">↓</button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeStep(this)">X</button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        }

        function removeStep(btn) {
            var row = btn.closest("tr");
            row.remove();
            reindex();
        }

        function moveStepUp(btn) {
            var row = btn.closest("tr");
            var prevRow = row.previousElementSibling;
            if (prevRow) {
                row.parentNode.insertBefore(row, prevRow);
                reindex();
            }
        }

        function moveStepDown(btn) {
            var row = btn.closest("tr");
            var nextRow = row.nextElementSibling;
            if (nextRow) {
                row.parentNode.insertBefore(nextRow, row);
                reindex();
            }
        }

        function reindex() {
            var rows = document.querySelectorAll("#stepsTable tbody tr");
            rows.forEach((row, idx) => {
                row.querySelector(".step-index").innerText = idx + 1;
                var select = row.querySelector("select");
                var hidden = row.querySelector("input[type=hidden]");

                // Es vital actualizar el atributo 'name' para que el ModelBinder de .NET reciba la lista en orden
                select.name = `Steps[${idx}].LocationId`;
                hidden.name = `Steps[${idx}].StepNumber`;
                hidden.value = idx + 1;
            });
        }
    </script>
}