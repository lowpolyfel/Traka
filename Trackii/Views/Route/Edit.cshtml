@model Trackii.Models.Admin.Route.RouteEditVm
@{
    var subfamilies = ViewBag.Subfamilies as List<(uint Id, string Name)> ?? new();
    var locations = ViewBag.Locations as List<(uint Id, string Name)> ?? new();

    // Pre-carga steps existentes
    var existing = Model.Steps
        .OrderBy(s => s.StepNumber)
        .Select(s => new { locationId = (int)s.LocationId, name = s.LocationName })
        .ToList();
}

<h2>Editar Ruta</h2>

@if (!string.IsNullOrWhiteSpace(Model.Error))
{
    <div style="color:red;">@Model.Error</div>
}

<form method="post" action="/Admin/Route/Save">
    @Html.AntiForgeryToken()

    <input type="hidden" name="Id" value="@Model.Id" />
    <input type="hidden" name="SubfamilyId" value="@Model.SubfamilyId" />

    <label>Subfamily</label><br />
    <select disabled>
        @foreach (var sf in subfamilies)
        {
            var sel = sf.Id == Model.SubfamilyId ? "selected" : "";
            <option value="@sf.Id" selected="@sel">@sf.Name</option>
        }
    </select>
    <br /><br />

    <label>Nombre</label><br />
    <input name="Name" value="@Model.Name" />
    <br /><br />

    <label>Versión</label><br />
    <input value="@Model.Version" disabled />
    <br /><br />

    <h3>Pasos (selecciona Locations)</h3>

    <div id="locationsPanel">
        @foreach (var loc in locations)
        {
            <label style="display:inline-block; margin-right:12px;">
                <input type="checkbox" class="loc-check" data-id="@loc.Id" data-name="@loc.Name" />
                @loc.Name
            </label>
        }
    </div>

    <h4>Orden actual</h4>
    <div id="selectedSteps"></div>

    <div id="stepsHidden"></div>

    <br />
    <button type="submit">Guardar</button>
    <a href="/Admin/Route">Cancelar</a>
</form>

<script>
    (function () {
        // Preload desde servidor
        let steps = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(existing));

        const selectedStepsDiv = document.getElementById("selectedSteps");
        const hiddenDiv = document.getElementById("stepsHidden");

        function render() {
            let html = "";
            if (steps.length === 0) {
                html = "<div>(Sin pasos todavía)</div>";
            } else {
                html += "<table border='1' cellpadding='6' cellspacing='0'>";
                html += "<tr><th>#</th><th>Location</th><th>Acciones</th></tr>";
                steps.forEach((s, idx) => {
                    html += "<tr>";
                    html += "<td>" + (idx + 1) + "</td>";
                    html += "<td>" + s.name + "</td>";
                    html += "<td>";
                    html += "<button type='button' data-act='up' data-idx='" + idx + "'>↑</button> ";
                    html += "<button type='button' data-act='down' data-idx='" + idx + "'>↓</button> ";
                    html += "<button type='button' data-act='remove' data-idx='" + idx + "'>Quitar</button>";
                    html += "</td>";
                    html += "</tr>";
                });
                html += "</table>";
            }
            selectedStepsDiv.innerHTML = html;

            let h = "";
            steps.forEach((s, idx) => {
                h += "<input type='hidden' name='Steps[" + idx + "].LocationId' value='" + s.locationId + "' />";
                h += "<input type='hidden' name='Steps[" + idx + "].StepNumber' value='" + (idx + 1) + "' />";
            });
            hiddenDiv.innerHTML = h;

            document.querySelectorAll(".loc-check").forEach(ch => {
                const id = parseInt(ch.getAttribute("data-id"));
                ch.checked = steps.some(x => x.locationId === id);
            });
        }

        document.querySelectorAll(".loc-check").forEach(ch => {
            ch.addEventListener("change", function () {
                const id = parseInt(this.getAttribute("data-id"));
                const name = this.getAttribute("data-name");

                if (this.checked) {
                    if (!steps.some(x => x.locationId === id)) {
                        steps.push({ locationId: id, name: name });
                    }
                } else {
                    steps = steps.filter(x => x.locationId !== id);
                }
                render();
            });
        });

        selectedStepsDiv.addEventListener("click", function (e) {
            const btn = e.target.closest("button");
            if (!btn) return;

            const act = btn.getAttribute("data-act");
            const idx = parseInt(btn.getAttribute("data-idx"));

            if (act === "remove") {
                steps.splice(idx, 1);
            } else if (act === "up" && idx > 0) {
                const tmp = steps[idx - 1];
                steps[idx - 1] = steps[idx];
                steps[idx] = tmp;
            } else if (act === "down" && idx < steps.length - 1) {
                const tmp = steps[idx + 1];
                steps[idx + 1] = steps[idx];
                steps[idx] = tmp;
            }
            render();
        });

        render();
    })();
</script>
