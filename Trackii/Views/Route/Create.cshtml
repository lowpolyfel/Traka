@model Trackii.Models.Admin.Route.RouteEditVm

<h2>Nueva Ruta</h2>

<form method="post" action="/Admin/Route/Save" id="routeForm">
    @Html.AntiForgeryToken()

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            @Html.ValidationSummary()
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <label>Subfamilia</label>
            <select asp-for="SubfamilyId" class="form-select" required>
                <option value="">-- Selecciona --</option>
                @foreach (var s in ViewBag.Subfamilies as List<(uint Id, string Name)>)
                {
                    <option value="@s.Id">@s.Name</option>
                }
            </select>
        </div>
        <div class="col-md-6">
            <label>Nombre de Ruta</label>
            <input asp-for="Name" class="form-control" placeholder="Ej: Ruta Estándar 2026" required />
        </div>
    </div>

    <hr />
    <h4>Pasos del Proceso (Flujo)</h4>
    <p class="text-muted">Agrega las ubicaciones en orden. Usa las flechas para reordenar.</p>

    <table class="table table-bordered" id="stepsTable">
        <thead>
            <tr>
                <th width="50">#</th>
                <th>Ubicación (Location)</th>
                <th width="120">Acción</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <button type="button" class="btn btn-secondary" onclick="addStep()">+ Agregar Paso</button>
    <br /><br />

    <button type="submit" class="btn btn-primary btn-lg">Guardar Ruta</button>
    <a href="/Admin/Route" class="btn btn-light">Cancelar</a>
</form>

<div style="display:none;">
    <select id="locationsSource">
        @foreach (var l in ViewBag.Locations as List<(uint Id, string Name)>)
        {
            <option value="@l.Id">@l.Name</option>
        }
    </select>
</div>

@section Scripts {
    <script>
        function addStep() {
            var tbody = document.querySelector("#stepsTable tbody");
            var index = tbody.rows.length;
            var options = document.getElementById("locationsSource").innerHTML;

            var row = `
                <tr>
                    <td class="step-index">${index + 1}</td>
                    <td>
                        <select name="Steps[${index}].LocationId" class="form-select">
                            ${options}
                        </select>
                        <input type="hidden" name="Steps[${index}].StepNumber" value="${index + 1}" />
                    </td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveStepUp(this)">↑</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveStepDown(this)">↓</button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeStep(this)">X</button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        }

        function removeStep(btn) {
            var row = btn.closest("tr");
            row.remove();
            reindex();
        }

        function moveStepUp(btn) {
            var row = btn.closest("tr");
            var prevRow = row.previousElementSibling;
            if (prevRow) {
                row.parentNode.insertBefore(row, prevRow);
                reindex();
            }
        }

        function moveStepDown(btn) {
            var row = btn.closest("tr");
            var nextRow = row.nextElementSibling;
            if (nextRow) {
                row.parentNode.insertBefore(nextRow, row);
                reindex();
            }
        }

        function reindex() {
            var rows = document.querySelectorAll("#stepsTable tbody tr");
            rows.forEach((row, idx) => {
                row.querySelector(".step-index").innerText = idx + 1;
                var select = row.querySelector("select");
                var hidden = row.querySelector("input[type=hidden]");

                select.name = `Steps[${idx}].LocationId`;
                hidden.name = `Steps[${idx}].StepNumber`;
                hidden.value = idx + 1;
            });
        }

        // Agregar uno inicial si está vacío
        if(document.querySelectorAll("#stepsTable tbody tr").length === 0) {
            addStep();
        }
    </script>
}