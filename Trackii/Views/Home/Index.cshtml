@{
    ViewData["Title"] = "Home Page";
}

<div class="card">
    <div class="page-header">
        <div>
            <h2>Bienvenido</h2>
            <p class="subtitle">Selecciona una opción del menú para comenzar.</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
            const video = document.getElementById("scannerVideo");
            const startButton = document.getElementById("scannerStart");
            const stopButton = document.getElementById("scannerStop");
            const status = document.getElementById("scannerStatus");
            const result = document.getElementById("scannerResult");
            const orderInput = document.getElementById("orderNumber");
            const partInput = document.getElementById("partNumber");

            let stream = null;
            let detector = null;
            let scanning = false;
            let lastValue = "";

            const setStatus = (text) => {
                status.textContent = text;
            };

            const supportsScanner = "BarcodeDetector" in window;
            if (!supportsScanner) {
                setStatus("Este navegador no soporta BarcodeDetector.");
                startButton.disabled = true;
            }

            const stopCamera = (announce = true) => {
                scanning = false;
                if (stream) {
                    stream.getTracks().forEach((track) => track.stop());
                    stream = null;
                }
                if (video) {
                    video.srcObject = null;
                }
                stopButton.disabled = true;
                startButton.disabled = !supportsScanner;
                if (announce) {
                    setStatus("Cámara detenida.");
                }
            };

            const handleValue = (value) => {
                const cleaned = value.trim();
                if (!cleaned || cleaned === lastValue) return;
                lastValue = cleaned;
                result.textContent = cleaned;
                if (/^\d{7}$/.test(cleaned)) {
                    orderInput.value = cleaned;
                } else {
                    partInput.value = cleaned;
                }
            };

            const scanLoop = async () => {
                if (!scanning || !detector) return;
                try {
                    const barcodes = await detector.detect(video);
                    if (barcodes.length > 0) {
                        const value = barcodes[0].rawValue || barcodes[0].value || "";
                        handleValue(value);
                    }
                } catch {
                    setStatus("No se pudo leer el código. Intenta de nuevo.");
                }
                requestAnimationFrame(scanLoop);
            };

            const startCamera = async () => {
                if (!supportsScanner || scanning) return;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });
                    video.srcObject = stream;
                    await video.play();
                    detector = new BarcodeDetector({
                        formats: ["code_128", "ean_13", "ean_8", "qr_code", "upc_a", "upc_e", "code_39"]
                    });
                    scanning = true;
                    startButton.disabled = true;
                    stopButton.disabled = false;
                    setStatus("Cámara activa. Apunta al código de barras.");
                    scanLoop();
                } catch (error) {
                    stopCamera(false);
                    setStatus("No fue posible abrir la cámara. Verifica permisos.");
                }
            };

            startButton?.addEventListener("click", startCamera);
            stopButton?.addEventListener("click", stopCamera);
            window.addEventListener("beforeunload", stopCamera);
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState !== "visible") {
                    stopCamera();
                }
            });
        })();
    </script>
}
